name: Sync from Google Drive

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: drive-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      BRANCH: develop
      DRIVE_FOLDER_MODE: latest
      STRIP_TOP_DIR: "0"

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install unzip & p7zip
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip p7zip-full

      - name: Install Google Drive SDK
        run: npm i googleapis

      # ❗️Ghi credentials ra thư mục tạm, KHÔNG nằm trong repo
      - name: Prepare Service Account credentials (temp path)
        id: sa
        run: |
          echo '${{ secrets.GDRIVE_CREDENTIALS_JSON }}' > "$RUNNER_TEMP/creds.json"
          echo "creds=$RUNNER_TEMP/creds.json" >> "$GITHUB_OUTPUT"

      - name: Download + extract + stage files
        env:
          # Trỏ script vào file creds ở thư mục tạm
          GDRIVE_CREDENTIALS_PATH: ${{ steps.sa.outputs.creds }}
          GDRIVE_FILE_ID: ${{ secrets.GDRIVE_FILE_ID }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          REPO_TARGET_DIR: ${{ secrets.REPO_TARGET_DIR }}
          DRIVE_FOLDER_MODE: ${{ env.DRIVE_FOLDER_MODE }}
          STRIP_TOP_DIR: ${{ env.STRIP_TOP_DIR }}
        run: node scripts/drive_sync.mjs

      # (Khuyến nghị) Loại bỏ file nhạy cảm nếu có trong archive trước khi commit
      - name: Sanitize sensitive files before commit
        run: |
          set -e
          # danh sách mẫu nhạy cảm; thêm/bớt tuỳ repo
          patterns='
          .env
          .env.*
          *.pem
          *id_rsa*
          *id_ed25519*
          *.key
          *keystore*
          *credentials.json
          '
          for p in $patterns; do
            # xóa cả file đã được stage (nếu có)
            git rm -rf --cached --ignore-unmatch $p 2>/dev/null || true
            rm -rf $p 2>/dev/null || true
          done

      - name: Commit & push to develo
